# 端到端加密功能安装指南

## 📦 安装新依赖

端到端加密功能需要两个新的Python库：

```bash
pip install cryptography>=41.0.0 keyring>=24.0.0
```

或者直接安装所有依赖：

```bash
pip install -r requirements.txt
```

## 🔐 首次使用

### 1. 启动应用

```bash
python main.py
```

### 2. 设置密码

首次启动时，会弹出"设置加密密码"对话框：

- 输入密码（至少8个字符）
- 确认密码
- 点击"设置密码"

⚠️ **重要提示**：
- 请务必记住密码！
- 忘记密码将无法恢复笔记
- 密码会自动保存到系统钥匙串

### 3. 自动解锁

设置密码后，下次启动应用时：
- 如果钥匙串可用，会自动解锁
- 如果自动解锁失败，需要手动输入密码
- 最多有3次输入机会

## 🔑 密码管理

### 修改密码

1. 启动应用并解锁
2. 点击菜单栏"安全" → "修改密码"
3. 输入当前密码
4. 输入新密码（至少8个字符）
5. 确认新密码
6. 应用会自动重新加密所有笔记

### 锁定笔记

随时可以锁定笔记：
- 点击菜单栏"安全" → "锁定笔记"
- 或使用快捷键 `Ctrl+Shift+L`
- 锁定后需要重新启动应用并输入密码

## 🔒 加密技术细节

### 加密算法
- **AES-256-CBC**：业界标准的对称加密算法
- **PBKDF2-HMAC-SHA256**：密钥派生函数，100,000次迭代
- **随机盐值**：每个密码使用独立的32字节随机盐值
- **随机IV**：每次加密使用16字节随机初始化向量

### 密钥存储
- 加密密钥存储在 macOS 系统钥匙串中
- 钥匙串受系统保护，只有当前用户可访问
- 支持通过 iCloud 钥匙串同步到其他设备

### 数据加密
- 所有笔记内容在保存前加密
- 本地数据库中存储的是加密后的内容
- 同步到 iCloud 的也是加密内容
- 只有在应用中解锁后才能查看明文

## 🛡️ 安全特性

### 端到端加密
- ✅ 只有您知道密码
- ✅ Apple 无法访问您的笔记内容
- ✅ 其他人无法访问您的笔记内容
- ✅ 即使数据库文件被盗，也无法解密

### 密码保护
- ✅ 密码不以明文存储
- ✅ 使用 PBKDF2 派生密钥，防止暴力破解
- ✅ 100,000次迭代，增加破解难度
- ✅ 随机盐值，防止彩虹表攻击

### 本地加密
- ✅ 笔记在本地数据库中以加密形式存储
- ✅ 即使有人访问您的电脑，也无法直接读取笔记
- ✅ 需要密码才能解密

## ⚠️ 重要提示

### 密码安全

1. **选择强密码**
   - 至少8个字符
   - 包含大小写字母、数字和特殊字符
   - 不要使用常见密码

2. **妥善保管密码**
   - 记住密码或使用密码管理器
   - 不要与他人分享密码
   - 定期更换密码

3. **密码不可恢复**
   - 忘记密码将永久丢失所有笔记
   - 没有"找回密码"功能
   - 这是端到端加密的特性

### 数据备份

虽然笔记已加密，但仍建议定期备份：

1. **导出笔记**
   - 使用"文件" → "导出"功能
   - 导出为 PDF、Word 或 Markdown
   - 保存到安全的位置

2. **Time Machine备份**
   - macOS 的 Time Machine 会自动备份数据库文件
   - 恢复时需要知道密码才能解密

3. **iCloud同步**
   - 启用 iCloud 同步作为额外备份
   - 同步的笔记也是加密状态

## 🔧 故障排除

### 忘记密码

如果忘记密码：
1. **无法恢复笔记**：这是端到端加密的特性
2. **重置应用**：删除数据库文件，重新开始
   ```bash
   rm -rf ~/Library/Group\ Containers/group.com.mathnotes/
   ```
3. **从备份恢复**：如果有导出的笔记，可以重新导入

### 自动解锁失败

如果自动解锁失败：
1. 手动输入密码
2. 检查系统钥匙串是否正常工作
3. 重新设置密码（会更新钥匙串）

### 钥匙串访问被拒绝

如果提示钥匙串访问被拒绝：
1. 打开"钥匙串访问"应用
2. 找到 `com.mathnotes.encryption` 项
3. 允许 Python 访问

## 📚 技术参考

### 加密配置文件

位置：`~/Library/Group Containers/group.com.mathnotes/encryption_config.json`

内容：
```json
{
  "password_hash": "Base64编码的密码哈希",
  "salt": "Base64编码的盐值",
  "encryption_enabled": true
}
```

### 数据库文件

位置：`~/Library/Group Containers/group.com.mathnotes/NoteStore.sqlite`

- 笔记内容（ZCONTENT字段）以加密形式存储
- 标题（ZTITLE字段）未加密（用于列表显示）

### 钥匙串项

- 服务名：`com.mathnotes.encryption`
- 账户名：`master_key`
- 内容：Base64编码的加密密钥

## 🎉 开始使用

现在您可以安全地使用笔记应用了！

1. 启动应用
2. 设置密码
3. 创建笔记
4. 所有内容自动加密

享受安全的笔记体验！🔐
