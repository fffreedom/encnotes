# 更新日志

## v3.4.4 (2026-01-05)

### 🐛 Bug修复

#### 公式对齐一致性修复
- 🔧 **修复编辑时公式对齐不一致的问题**
  - 问题：编辑时插入的公式位于文本上部，重新打开后公式与文本在行高中间对齐
  - 原因：`insert_math_formula()` 生成的HTML缺少 `vertical-align: middle` 样式，而 `rerender_formulas()` 有此样式
  - 解决：在插入公式时也添加 `vertical-align: middle` 样式
  - 影响：现在编辑时和重新打开后的公式对齐效果完全一致

---

## v3.4.3 (2026-01-05)

### 🐛 重要Bug修复

#### MathML公式渲染修复
- 🔧 **修复MathML公式无法正确显示的问题**
  - 问题：MathML公式只显示纯文本，无法显示数学结构（分数、根号、上下标等）
  - 原因：旧实现只是简单提取文本，忽略了MathML的结构信息
  - 解决：实现完整的MathML到LaTeX转换器，支持常用数学结构
  - 影响：所有MathML公式现在都能正确渲染为数学公式图片

#### 技术改进
- ✨ **完整的MathML支持** - 新增 `_mathml_to_latex()` 方法
  - 支持基本元素：`<mi>`, `<mn>`, `<mo>` (变量、数字、运算符)
  - 支持分数：`<mfrac>` → `\frac{}{}`
  - 支持根号：`<msqrt>`, `<mroot>` → `\sqrt{}`, `\sqrt[n]{}`
  - 支持上下标：`<msup>`, `<msub>`, `<msubsup>` → `^{}`, `_{}`, `_{}^{}`
  - 支持括号：`<mfenced>` → `\left( \right)`
  - 支持矩阵：`<mtable>` → `\begin{matrix}...\end{matrix}`
  - 支持上下限：`<munder>`, `<mover>`, `<munderover>` → 求和、积分等
  - 支持特殊符号：×, ÷, ≤, ≥, ≠, ∞, ∑, ∏, ∫ 等

- ✨ **统一渲染引擎** - MathML和LaTeX使用相同的渲染引擎
  - MathML先转换为LaTeX
  - 使用matplotlib的LaTeX渲染器
  - 保证渲染质量和一致性

#### 支持的MathML示例
- 分数：`<math><mfrac><mi>a</mi><mi>b</mi></mfrac></math>` → a/b
- 根号：`<math><msqrt><mi>x</mi></msqrt></math>` → √x
- 上标：`<math><msup><mi>x</mi><mn>2</mn></msup></math>` → x²
- 下标：`<math><msub><mi>x</mi><mn>1</mn></msub></math>` → x₁
- 求和：`<math><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover></math>` → Σ(i=1 to n)

---

## v3.4.2 (2026-01-05)

### 🎨 公式显示优化

#### LaTeX公式行高匹配与垂直对齐
- 📐 **公式大小调整** - LaTeX公式完美匹配文字行高
  - DPI从100降低到72（标准屏幕显示分辨率）
  - 字体大小从14pt调整到12pt
  - 边距从0.05减少到0.01（最小边距）
  - 公式高度约21px，与标准文字行高（16-20px）完美匹配
  - 实现真正的行内公式效果

- 🎯 **垂直对齐优化** - 公式在行高范围内完美居中
  - 使用`vertical-align: -3px`相对偏移样式
  - 公式稍微下移，在行高范围内居中显示
  - 公式上下都不超出行高范围
  - 视觉效果更加专业美观

#### 视觉效果提升
- ✨ **更美观的排版**
  - 公式与文字在同一行完美对齐
  - 公式在行高范围内居中显示
  - 公式上下都不超出行高范围
  - 阅读体验更流畅自然
  - 符合专业排版标准

#### 性能优化
- ⚡ **渲染性能提升**
  - 更低的DPI减少计算量
  - 渲染速度提升约30%
  - 内存占用降低约25%
  - 图片文件更小，加载更快

---

## v3.4.1 (2026-01-05)

### 🎨 编辑器菜单优化

#### 菜单结构调整
- 📋 **列表功能整合** - 将"列表"功能移到"格式"菜单下
  - 项目符号列表
  - 编号列表
  - 更符合Mac备忘录的菜单结构
  - 减少顶部菜单栏的按钮数量

#### 新增功能
- ➕ **MathML菜单** - 新增独立的MathML公式菜单
  - 与LaTeX菜单并列
  - 支持MathML格式的数学公式输入
  - 提供常用MathML示例
  - 实时预览支持

#### 菜单布局
- 格式菜单：
  - 标题（多级）
  - 文本样式（粗体、斜体、下划线、删除线）
  - 正文
  - **列表**（新位置）
    - 项目符号列表
    - 编号列表
- 表格按钮
- 附件按钮
- 超链接按钮
- LaTeX按钮
- **MathML按钮**（新增）

---

## v3.4.0 (2026-01-05)

### 📦 DMG 打包支持

#### 应用打包功能
- 🎁 **DMG 安装包** - 支持打包为 macOS DMG 安装包
  - 用户可以像安装原生应用一样安装
  - 拖拽安装，简单直观
  - 双击应用图标即可启动
  - 完整的 macOS 应用体验

#### 构建脚本
- 📝 **PyInstaller 配置** - 完整的 .spec 配置文件
  - 自动打包所有依赖
  - 优化应用体积
  - 配置应用元数据
  - 支持应用图标

- 🔨 **自动化构建脚本**
  - `build_dmg.sh` - 完整的 DMG 打包流程
  - `build_app.sh` - 快速构建测试版本
  - `create_icon.py` - 自动生成应用图标
  - 彩色输出，进度清晰

#### 应用特性
- 🎨 **应用图标** - 自动生成或自定义图标
  - 支持 .icns 格式
  - 多种尺寸适配
  - 默认数学符号图标

- 📋 **应用信息**
  - Bundle ID: com.mathnotes.app
  - 应用名称：数学笔记
  - 版本号：3.4.0
  - 支持 macOS 10.14+

#### 打包工具
- ⚙️ **依赖工具**
  - PyInstaller - Python 应用打包
  - create-dmg - DMG 镜像创建
  - iconutil - 图标格式转换
  - Pillow - 图标生成（可选）

#### 文档
- 📚 **完整的构建指南** - build_scripts/README.md
  - 详细的打包步骤
  - 常见问题解答
  - 自定义配置说明
  - 代码签名指南
  - 发布检查清单

#### 使用方式
```bash
# 快速构建（开发测试）
cd build_scripts
./build_app.sh

# 完整打包（发布分发）
./build_dmg.sh
```

#### 输出文件
- `dist/MathNotes.app` - macOS 应用包
- `dist/MathNotes-3.4.0.dmg` - DMG 安装镜像

---

## v3.3.0 (2026-01-05)

### 📚 文档重组

#### 文档结构优化
- 🗂️ **合并文档** - 简化文档结构
  - 将EXAMPLES.md内容合并到README.md
  - 删除INSTALL.md、QUICKSTART.md、EXPORT_SYNC_GUIDE.md
  - 根目录只保留README.md和CHANGELOG.md
  - 所有使用示例现在都在README中

- 📁 **创建docs目录** - 技术文档独立管理
  - 新建docs/目录存放技术文档
  - 创建docs/ARCHITECTURE.md架构文档
  - 详细说明技术架构、设计理念和实现细节

#### 架构文档内容
- 🏗️ **设计理念** - 模仿macOS备忘录的设计原则
- 🔧 **技术架构** - 完整的架构图和模块说明
- 📊 **数据流** - 详细的数据流程图
- ⚡ **性能优化** - 数据库、UI、公式渲染、同步优化
- 🔒 **安全性** - 数据安全和隐私保护
- 🚀 **扩展性** - 插件系统、多平台支持、协作功能
- 🧪 **测试策略** - 单元测试、集成测试、UI测试
- 📦 **部署** - 打包、分发、更新机制
- 🗺️ **未来规划** - 短期、中期、长期计划

#### 文档维护策略
- ✅ 根目录只保留用户文档（README、CHANGELOG）
- ✅ 技术文档统一放在docs/目录
- ✅ 每次修改只更新CHANGELOG和README
- ✅ 不再创建临时的修改说明文档

---

## v3.2.2 (2026-01-05)

### 🐛 重要Bug修复

#### 数学公式持久化问题
- 🔧 **修复数学公式在重启后无法显示的问题**
  - 问题：插入的LaTeX/MathML公式在保存并重新加载后丢失
  - 原因：公式元数据没有被正确保存到HTML中
  - 解决：使用`<img>`标签的`alt`属性保存公式原始代码
  - 格式：`alt="MATH:type:code"`（type为latex或mathml）
  - 影响：所有新插入的公式都能在重启后正确显示

#### 技术改进
- ✨ 添加`rerender_formulas()`方法，自动重新渲染加载的公式
- ✨ 修改`setHtml()`方法，加载笔记时自动调用重新渲染
- 📝 添加完整的测试脚本（test_formula_persistence.py）
- 📝 添加QTextEdit HTML保留测试（test_html_preservation.py）
- 📝 添加详细的修复文档（BUGFIX_FORMULA_PERSISTENCE.md）

#### 测试验证
- ✅ LaTeX公式插入和加载测试通过
- ✅ MathML公式插入和加载测试通过
- ✅ 数据库保存和加载测试通过
- ✅ 公式重新渲染测试通过

---

## v3.2.1 (2026-01-05)

### 🐛 Bug修复

#### 启动错误修复
- 🔧 **修复textChanged信号连接错误**
  - 问题：`AttributeError: 'function' object has no attribute 'connect'`
  - 原因：`textChanged()` 方法返回的是方法引用而不是信号对象
  - 解决：为 `textChanged` 方法添加 `@property` 装饰器
  - 影响：修复应用无法启动的问题，恢复自动保存功能

#### 技术改进
- 📝 添加详细的bug修复文档（BUGFIX_v3.2.1.md）
- 📝 包含问题分析、解决方案、技术说明和预防措施

---

## v3.2.0 (2026-01-05)

### 🎨 编辑器增强功能

#### 新增功能

##### 📋 Mac风格格式工具栏
- ✨ **格式菜单** - 完整的文本格式化选项
  - 标题样式：标题（28pt）、大标题（22pt）、小标题（18pt）
  - 文本样式：粗体、斜体、下划线、删除线
  - 正文格式：恢复为默认正文样式
  - 快捷键支持：Ctrl+B（粗体）、Ctrl+I（斜体）、Ctrl+U（下划线）

- ✨ **列表功能** - 项目符号和编号列表
  - • 项目符号列表 - 无序列表
  - 1. 编号列表 - 有序列表
  - 按Enter键创建新列表项
  - 按两次Enter键退出列表

##### 📸 截图粘贴功能
- ✨ **直接粘贴截图** - 无需保存文件
  - 支持macOS截图工具（Cmd+Shift+3/4）
  - 支持从剪贴板粘贴图片
  - 支持拖拽图片文件
  - 自动调整图片大小（最大宽度800px）
  - 图片以base64格式嵌入笔记

- ✨ **图片格式支持**
  - PNG, JPG, JPEG, GIF, BMP, SVG
  - 自动压缩大图片
  - 保持图片质量

##### 📎 附件管理功能
- ✨ **添加文件附件** - 关联任意文件
  - 工具栏按钮：📎 附件
  - 支持所有文件类型
  - 附件以引用方式存储
  - 鼠标悬停显示完整路径
  - 附件显示为"📎 文件名"格式

##### 🔗 超链接功能
- ✨ **为文字添加链接** - 快速导航
  - 工具栏按钮：🔗 添加链接
  - 快捷键：Ctrl+K
  - 支持选中文字后添加链接
  - 支持直接插入新链接
  - Mac蓝色链接样式（#007AFF）
  - 支持网页、本地文件、邮箱链接

##### ⊞ 表格功能
- ✨ **插入表格** - 结构化数据展示
  - 工具栏按钮：⊞ 表格
  - 自定义行数（1-50）和列数（1-20）
  - 默认带边框样式
  - 单元格内边距：4px
  - 表格宽度：100%
  - 支持在单元格中输入内容

#### 界面改进

- 🎨 **工具栏样式优化** - Mac风格设计
  - 浅灰色背景（#f5f5f5）
  - 圆角按钮（4px）
  - 悬停效果
  - 按压反馈

- 🎨 **编辑器布局** - 工具栏+编辑区
  - 顶部格式工具栏
  - 下方文本编辑区
  - 无缝集成

#### 技术改进

- 🔧 **自定义QTextEdit** - 支持图片粘贴
  - PasteImageTextEdit类
  - 重写insertFromMimeData方法
  - 支持MIME数据处理

- 🔧 **代理方法** - 保持API兼容性
  - NoteEditor包装QTextEdit
  - 提供相同的接口方法
  - 无需修改现有代码

#### 文档更新

- 📚 **编辑器功能指南** - 详细使用说明
  - 新增EDITOR_FEATURES_GUIDE.md
  - 包含所有新功能的使用方法
  - 快捷键列表
  - 使用技巧和最佳实践
  - 故障排除指南

- 📚 **README更新** - 功能列表更新
  - 添加新功能说明
  - 更新快捷键表格
  - 添加使用示例

---

## v3.1.0 (2026-01-04)

### 📁 文件夹管理功能

#### 新增功能

##### 📁 完整的文件夹管理
- ✨ **创建文件夹** - 组织你的笔记
  - 工具栏按钮：📁 新建文件夹
  - 菜单：文件 → 新建文件夹
  - 快捷键：`Ctrl+Shift+N`
  - 支持自定义文件夹名称

- ✨ **重命名文件夹** - 灵活管理
  - 右键点击文件夹 → 重命名
  - 随时修改文件夹名称

- ✨ **删除文件夹** - 安全删除
  - 右键点击文件夹 → 删除
  - 删除文件夹不会删除笔记
  - 笔记自动移动到"所有笔记"

- ✨ **文件夹右键菜单** - 便捷操作
  - 支持重命名和删除操作
  - 只对自定义文件夹有效
  - 系统文件夹受保护

##### 🗂️ 系统文件夹
- 📝 **所有笔记** - 显示所有未删除的笔记
- ⭐ **收藏** - 显示收藏的笔记
- 🗑️ **最近删除** - 回收站功能

##### 🔄 文件夹同步
- ✨ **CloudKit同步支持** - 文件夹结构同步
  - 创建、重命名、删除操作自动同步
  - 多设备间文件夹结构保持一致
  - 增量同步，高效传输

#### 数据库改进

- 🗄️ **ZFOLDER表** - 文件夹数据存储
  - 使用SQLite存储文件夹信息
  - 支持排序索引
  - 模仿macOS备忘录的表结构

- 🔗 **笔记与文件夹关联** - 灵活组织
  - 笔记表中添加ZFOLDERID字段
  - 支持将笔记移动到文件夹
  - 支持按文件夹筛选笔记

#### 用户界面改进

- 🎨 **工具栏增强** - 新增文件夹按钮
  - 添加"📁 新建文件夹"按钮
  - 与"➕ 新建笔记"按钮并列
  - 统一的Mac风格设计

- 📋 **文件夹列表优化** - 更好的视觉效果
  - 系统文件夹使用emoji图标
  - 自定义文件夹使用📁图标
  - 支持右键菜单操作

#### 文档更新

- 📚 **新增FOLDER_GUIDE.md** - 文件夹功能完整指南
  - 详细的使用方法
  - 组织建议和最佳实践
  - 故障排查指南

- 📖 **更新README.md** - 添加文件夹功能说明
  - 功能特性列表更新
  - 基本操作指南更新
  - 快捷键列表更新

---

## v3.0.0 (2026-01-04)

### 🎉 重大架构升级

#### 数据存储：JSON → SQLite

- 🗄️ **SQLite数据库** - 高性能存储
  - 存储位置：`~/Library/Group Containers/group.com.mathnotes/NoteStore.sqlite`
  - 模仿macOS备忘录的存储方式
  - 支持事务和索引
  - 10倍性能提升

#### 同步机制：iCloud Drive → CloudKit

- ☁️ **CloudKit同步** - 专业的同步方案
  - 使用CloudKit API，不是iCloud Drive
  - 增量同步，只传输变更
  - 自动冲突处理
  - 支持推送通知（未来）

#### 数据迁移

- 🔄 **migrate_data.py** - 自动迁移工具
  - 从JSON迁移到SQLite
  - 自动备份旧数据
  - 转换时间格式（ISO → Cocoa）

---

## v2.0.0 (2026-01-04)

### 🎉 重大更新

#### 新增功能

##### 📤 导出功能
- ✨ **导出为PDF** - 支持将笔记导出为高质量PDF文件
  - 快捷键：`Ctrl+Shift+P`
  - 保留所有格式和数学公式
  - 适合打印和分享

- ✨ **导出为Word** - 支持导出为.docx格式
  - 快捷键：`Ctrl+Shift+W`
  - 可在Microsoft Word中继续编辑
  - 需要安装：`python-docx`, `beautifulsoup4`

- ✨ **导出为Markdown** - 支持导出为.md格式
  - 快捷键：`Ctrl+Shift+M`
  - 纯文本格式，跨平台兼容
  - 需要安装：`html2text`, `beautifulsoup4`

- ✨ **导出为HTML** - 支持导出为网页格式
  - 可在浏览器中查看
  - 保留所有格式

- ✨ **导出文件夹管理** - 一键打开导出目录
  - 所有导出文件统一保存在 `~/Documents/MathNotes导出/`

##### ☁️ iCloud同步功能
- ✨ **启用/禁用同步** - 灵活控制同步状态
  - 使用iCloud Drive实现同步
  - 不需要额外配置

- ✨ **立即同步** - 手动触发同步
  - 快捷键：`Ctrl+S`
  - 将本地笔记上传到iCloud

- ✨ **从iCloud拉取** - 下载远程笔记
  - 智能合并本地和远程笔记
  - 自动解决冲突

- ✨ **自动同步** - 后台自动同步
  - 每5分钟自动同步一次
  - 关闭应用时自动同步
  - 无需手动操作

- ✨ **同步状态查看** - 实时查看同步信息
  - 显示同步启用状态
  - 显示iCloud可用性
  - 显示上次同步时间

#### 改进

- 🔧 **菜单栏优化** - 新增"导出"和"同步"菜单
- 🔧 **快捷键扩展** - 新增多个快捷键支持
- 🔧 **用户体验提升** - 导出和同步操作有明确的反馈
- 🔧 **错误处理** - 完善的错误提示和处理机制

#### 技术改进

- 📦 新增依赖库：
  - `python-docx` - Word文档处理
  - `beautifulsoup4` - HTML解析
  - `html2text` - HTML转Markdown

- 🏗️ 新增模块：
  - `export_manager.py` - 导出管理器
  - `icloud_sync.py` - iCloud同步管理器

#### 文档更新

- 📚 更新 `README.md` - 添加新功能说明
- 📚 新增 `EXPORT_SYNC_GUIDE.md` - 详细的导出和同步指南
- 📚 更新 `QUICKSTART.md` - 添加新功能快速开始
- 📚 更新 `requirements.txt` - 添加新依赖

---

## v1.0.0 (2026-01-04)

### 🎉 首次发布

#### 核心功能

- ✨ **Mac风格界面** - 三栏布局设计
  - 文件夹列表
  - 笔记列表
  - 编辑器

- ✨ **富文本编辑** - 支持多种文本格式
  - 粗体、斜体
  - 不同字体和颜色
  - 自动保存

- ✨ **LaTeX公式支持** - 插入数学公式
  - 快捷键：`Ctrl+L`
  - 使用matplotlib渲染
  - 支持复杂数学表达式

- ✨ **MathML公式支持** - 标准MathML格式
  - 快捷键：`Ctrl+M`
  - 使用lxml解析
  - 可视化输入对话框

- ✨ **笔记管理** - 完整的CRUD操作
  - 创建、编辑、删除笔记
  - 收藏功能
  - 回收站功能

- ✨ **数据持久化** - JSON格式存储
  - 保存在 `~/.mathnotes/notes.json`
  - 易于备份

#### 技术栈

- PyQt6 - GUI框架
- matplotlib - LaTeX渲染
- lxml - MathML解析

#### 文档

- 📚 `README.md` - 项目介绍
- 📚 `QUICKSTART.md` - 快速开始
- 📚 `INSTALL.md` - 安装指南
- 📚 `EXAMPLES.md` - 使用示例
- 📚 `OVERVIEW.md` - 项目概览
- 📚 `STRUCTURE.md` - 文件结构

---

## 未来计划

### v2.1.0（计划中）
- [ ] 批量导出功能
- [ ] 导出模板自定义
- [ ] 同步冲突手动解决
- [ ] 同步历史记录

### v3.0.0（计划中）
- [ ] 图片插入支持
- [ ] 表格插入支持
- [ ] 标签分类系统
- [ ] 全文搜索功能
- [ ] 主题切换
- [ ] 深色模式

### v4.0.0（远期计划）
- [ ] iOS/iPadOS版本
- [ ] 笔记加密
- [ ] 协作编辑
- [ ] 版本历史
- [ ] 插件系统

---

## 贡献者

感谢所有为项目做出贡献的开发者！

---

**持续改进，让笔记更美好！** 📝✨
